<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APNG Builder: Drag & Drop Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/pako@1.0.11/dist/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); width: 100%; max-width: 650px; }
        h2 { margin-top: 0; color: #1a1a1a; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #eef0f2; border-radius: 8px; }
        .section-title { font-weight: bold; margin-bottom: 10px; display: block; color: #555; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–æ–Ω –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è */
        .drop-zone { border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; color: #777; }
        .drop-zone.highlight { border-color: #007bff; background: #e7f3ff; color: #007bff; }
        .bg-zone { background: #fffcf0; }
        .anim-zone { background: #f8f9fa; }
        
        .file-item { display: flex; align-items: center; gap: 10px; background: #fff; padding: 8px; margin-bottom: 5px; border-radius: 6px; border: 1px solid #eee; font-size: 13px; }
        .file-item img { width: 40px; height: 40px; object-fit: contain; background: #eee; border-radius: 4px; }
        .file-item input { width: 60px; padding: 4px; border: 1px solid #ddd; }

        #buildBtn { width: 100%; background: #28a745; color: white; border: none; padding: 15px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        #buildBtn:hover { background: #218838; }
        #buildBtn:disabled { background: #ccc; cursor: not-allowed; }
        
        #status { margin-top: 15px; text-align: center; font-weight: bold; }
        #resultContainer { margin-top: 20px; text-align: center; display: none; padding-top: 20px; border-top: 2px solid #eee; }
        #preview { max-width: 100%; border: 1px solid #ddd; border-radius: 8px; background: white; margin-bottom: 10px; }
        .file-size { font-size: 18px; color: #333; margin: 10px 0; font-weight: bold; }
        .download-btn { display: inline-block; background: #007bff; color: white; text-decoration: none; padding: 12px 24px; border-radius: 6px; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h2>APNG –°–±–æ—Ä—â–∏–∫</h2>
    
    <div class="section">
        <span class="section-title">1. –°—Ç–∞—Ç–∏—á–Ω—ã–π —Ñ–æ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
        <div id="dropZoneBg" class="drop-zone bg-zone">
            –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Ñ–æ–Ω–∞ —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞
            <input type="file" id="bgInput" accept="image/png, image/jpeg" style="display:none">
        </div>
        <div id="bgPreviewContainer" style="display:none; align-items: center; gap: 10px; margin-top: 10px;">
            <img id="bgThumb" style="height: 40px; border-radius: 4px;">
            <span id="bgName" style="font-size: 12px; color: #666; flex-grow: 1;"></span>
            <button onclick="clearBg()" style="padding: 5px; cursor: pointer;">‚ùå</button>
        </div>
    </div>

    <div class="section">
        <span class="section-title">2. –ö–∞–¥—Ä—ã –∞–Ω–∏–º–∞—Ü–∏–∏</span>
        <div id="dropZoneAnim" class="drop-zone anim-zone">
            –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã –∫–∞–¥—Ä–æ–≤ —Å—é–¥–∞
            <input type="file" id="fileInput" multiple accept="image/png" style="display:none">
        </div>
        <div id="fileList" style="margin-top:10px; max-height: 250px; overflow-y: auto;"></div>
    </div>

    <button id="buildBtn" disabled>–°–æ–±—Ä–∞—Ç—å –∏ –ø–æ—Å—á–∏—Ç–∞—Ç—å –≤–µ—Å</button>
    <div id="status"></div>

    <div id="resultContainer">
        <div class="file-size" id="finalSize">–í–µ—Å: 0 –ö–ë</div>
        <img id="preview"><br>
        <a id="downloadLink" class="download-btn">–°–∫–∞—á–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π APNG</a>
    </div>
</div>

<script>
    const bgInput = document.getElementById('bgInput');
    const fileInput = document.getElementById('fileInput');
    const buildBtn = document.getElementById('buildBtn');
    const status = document.getElementById('status');
    const resultContainer = document.getElementById('resultContainer');
    const finalSizeText = document.getElementById('finalSize');
    const preview = document.getElementById('preview');
    const downloadLink = document.getElementById('downloadLink');

    let animationFiles = [];
    let bgFile = null;

    // --- –õ–û–ì–ò–ö–ê DRAG & DROP ---

    function setupDropZone(zoneId, inputId, callback) {
        const zone = document.getElementById(zoneId);
        const input = document.getElementById(inputId);

        zone.addEventListener('click', () => input.click());

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            zone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            zone.addEventListener(eventName, () => zone.classList.add('highlight'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            zone.addEventListener(eventName, () => zone.classList.remove('highlight'), false);
        });

        zone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            callback(files);
        });

        input.addEventListener('change', (e) => callback(e.target.files));
    }

    setupDropZone('dropZoneBg', 'bgInput', (files) => {
        if (files.length > 0) {
            bgFile = files[0];
            document.getElementById('bgThumb').src = URL.createObjectURL(bgFile);
            document.getElementById('bgName').innerText = bgFile.name;
            document.getElementById('bgPreviewContainer').style.display = 'flex';
        }
    });

    setupDropZone('dropZoneAnim', 'fileInput', (files) => {
        const newFiles = Array.from(files);
        animationFiles = animationFiles.concat(newFiles);
        renderFileList();
    });

    function renderFileList() {
        const container = document.getElementById('fileList');
        container.innerHTML = '';
        animationFiles.forEach((file, i) => {
            const div = document.createElement('div');
            div.className = 'file-item';
            div.innerHTML = `
                <span>${i+1}</span>
                <img src="${URL.createObjectURL(file)}">
                <div style="flex-grow:1; overflow:hidden;">${file.name}</div>
                <input type="number" class="delay-input" value="200" min="10"> –º—Å
                <button onclick="removeFrame(${i})" style="border:none; background:none; cursor:pointer;">üóëÔ∏è</button>
            `;
            container.appendChild(div);
        });
        buildBtn.disabled = animationFiles.length === 0;
    }

    function removeFrame(index) {
        animationFiles.splice(index, 1);
        renderFileList();
    }

    function clearBg() {
        bgFile = null;
        document.getElementById('bgPreviewContainer').style.display = 'none';
    }

    // --- –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –í–ï–°–ê ---
    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    // --- –°–ë–û–†–ö–ê ---
    buildBtn.addEventListener('click', async () => {
        status.innerText = "‚è≥ –°–±–æ—Ä–∫–∞ –∏ —Ä–∞—Å—á–µ—Ç –≤–µ—Å–∞...";
        status.style.color = "#007bff";
        buildBtn.disabled = true;

        try {
            const delays = Array.from(document.querySelectorAll('.delay-input')).map(i => parseInt(i.value) || 100);
            const frames = [];
            let w, h;

            let bgImg = bgFile ? await loadImage(bgFile) : null;

            for (let i = 0; i < animationFiles.length; i++) {
                const img = await loadImage(animationFiles[i]);
                if (i === 0) { w = img.width; h = img.height; }

                const canvas = document.createElement('canvas');
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');

                if (bgImg) ctx.drawImage(bgImg, 0, 0, w, h);
                ctx.drawImage(img, 0, 0, w, h);
                frames.push(ctx.getImageData(0, 0, w, h).data.buffer);
            }

            const resultBuffer = UPNG.encode(frames, w, h, 0, delays);
            const blob = new Blob([resultBuffer], { type: "image/png" });
            const finalUrl = URL.createObjectURL(blob);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Å
            finalSizeText.innerText = "–í–µ—Å —Ñ–∞–π–ª–∞: " + formatBytes(blob.size);
            
            preview.src = finalUrl;
            downloadLink.href = finalUrl;
            downloadLink.download = "result.png";
            
            resultContainer.style.display = "block";
            status.innerText = "‚úÖ –ì–æ—Ç–æ–≤–æ!";
            status.style.color = "green";
        } catch (err) {
            status.innerText = "‚ùå –û—à–∏–±–∫–∞: " + err.message;
            status.style.color = "red";
        } finally {
            buildBtn.disabled = false;
        }
    });

    function loadImage(file) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = URL.createObjectURL(file);
        });
    }
</script>

</body>
</html>
