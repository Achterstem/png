<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APNG Master v2.4</title>
    <script src="https://cdn.jsdelivr.net/npm/pako@1.0.11/dist/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); width: 100%; max-width: 1100px; }
        .grid { display: grid; grid-template-columns: 360px 1fr; gap: 20px; }
        
        .section { margin-bottom: 15px; padding: 12px; border: 1px solid #eef0f2; border-radius: 8px; background: #fafafa; }
        .drop-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .drop-zone { border: 2px dashed #ccc; padding: 10px; text-align: center; border-radius: 8px; cursor: pointer; color: #777; font-size: 13px; flex-grow: 1; transition: 0.3s; }
        .drop-zone:hover { border-color: #007bff; background: #f0f7ff; }
        .btn-del-small { background: #fee; border: 1px solid #fcc; border-radius: 8px; cursor: pointer; padding: 0 10px; color: #d33; transition: 0.2s; }
        .btn-del-small:hover { background: #fdd; }

        .controls-panel { background: #222; color: #fff; padding: 12px; border-radius: 8px; margin-bottom: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; box-sizing: border-box; }
        .controls-panel label { font-size: 11px; display: flex; flex-direction: column; gap: 4px; }
        .controls-panel input { background: #444; border: 1px solid #555; color: #fff; padding: 6px; border-radius: 4px; width: 100%; box-sizing: border-box; min-width: 0; }

        /* –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ —Å Drag-and-Drop */
        .file-list { max-height: 300px; overflow-y: auto; border: 1px solid #eee; background: white; margin-top: 10px; border-radius: 6px; }
        .file-item { display: flex; align-items: center; gap: 8px; padding: 6px; border-bottom: 1px solid #eee; font-size: 11px; cursor: grab; background: #fff; user-select: none; }
        .file-item:active { cursor: grabbing; background: #f9f9f9; }
        .file-item.ghost { opacity: 0.4; background: #e7f3ff; }
        .file-item img { width: 35px; height: 35px; object-fit: contain; border: 1px solid #eee; background: #fdfdfd; border-radius: 4px; }
        .file-item .drag-handle { color: #ccc; cursor: grab; font-size: 16px; }
        
        #workArea { position: relative; background: #333; border-radius: 8px; overflow: auto; display: flex; align-items: center; justify-content: center; min-height: 450px; border: 2px solid #444; }
        #bgCanvasPreview { 
            background-color: #fff; 
            background-image: linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%, #eee), linear-gradient(45deg, #eee 25%, white 25%, white 75%, #eee 75%, #eee); 
            background-size: 20px 20px; background-position: 0 0, 10px 10px; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5); cursor: move; 
        }
        
        .btn { border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px; }
        .btn-preset { background: #6f42c1; color: white; }
        .btn-build { background: #28a745; color: white; font-size: 16px; margin-top: 15px; }
        
        #status { margin-top: 10px; text-align: center; font-size: 14px; font-weight: bold; min-height: 1.2em; }
        #loaderStatus { color: #856404; font-size: 12px; text-align: center; margin-top: 5px; display: none; }

        #resultContainer { margin-top: 20px; padding: 20px; border: 2px solid #28a745; border-radius: 8px; background: #f6fff6; display: none; }
        #finalPreview { max-width: 100%; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 1px solid #ccc; background: white; }
        .download-btn { display: inline-block; margin-top: 15px; background: #007bff; color: white; padding: 12px 25px; text-decoration: none; border-radius: 6px; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <div class="grid">
        <div class="sidebar">
            <h3 style="margin-top:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ APNG v2</h3>
            <div class="section">
                <div class="drop-row">
                    <div id="dzBg" class="drop-zone">üì• –§–æ–Ω (–æ–ø—Ü)</div>
                    <button class="btn-del-small" title="–£–¥–∞–ª–∏—Ç—å —Ñ–æ–Ω" onclick="removeBg()">üóëÔ∏è</button>
                </div>
                <div class="drop-row">
                    <div id="dzAnim" class="drop-zone">üì• –ö–∞–¥—Ä—ã</div>
                    <button class="btn-del-small" title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∫–∞–¥—Ä—ã" onclick="clearAllFrames()">üóëÔ∏è</button>
                </div>
                <input type="file" id="bgIn" style="display:none">
                <input type="file" id="animIn" multiple style="display:none">
            </div>

            <div class="controls-panel">
                <div style="grid-column: 1/3; font-size: 11px; color: #888; text-transform: uppercase;">–ü–æ–ª—è (px)</div>
                <label>–°–≤–µ—Ä—Ö—É <input type="number" id="padTop" value="0"></label>
                <label>–°–Ω–∏–∑—É <input type="number" id="padBottom" value="0"></label>
                <label>–°–ª–µ–≤–∞ <input type="number" id="padLeft" value="0"></label>
                <label>–°–ø—Ä–∞–≤–∞ <input type="number" id="padRight" value="0"></label>
                <div style="grid-column: 1/3; height: 1px; background: #444; margin: 4px 0;"></div>
                <div style="grid-column: 1/3; font-size: 11px; color: #888; text-transform: uppercase;">–°–º–µ—â–µ–Ω–∏–µ</div>
                <label>X <input type="number" id="posX" value="0"></label>
                <label>Y <input type="number" id="posY" value="0"></label>
            </div>

            <div class="file-list" id="fileList"></div>
            
            <button class="btn btn-preset" onclick="applySMPreset()">–ü—Ä–µ—Å–µ—Ç "–°–ú –ú–µ–¥–∞–ª–∏"</button>
            <button class="btn btn-build" id="buildBtn" disabled>–°–û–ë–†–ê–¢–¨ APNG</button>
            
            <div id="loaderStatus">‚åõ –ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div id="status"></div>
        </div>

        <div class="main">
            <div id="workArea">
                <canvas id="bgCanvasPreview"></canvas>
            </div>
            
            <div id="resultContainer">
                <h3 style="margin-top:0">‚úÖ –ì–æ—Ç–æ–≤–æ</h3>
                <div id="finalSize" style="margin-bottom:10px; font-weight:bold; color: #28a745;"></div>
                <img id="finalPreview">
                <br>
                <a id="dlBtn" class="download-btn">–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª (.png)</a>
            </div>
        </div>
    </div>
</div>

<script>
    let bgImg = null;
    let loadedFrames = []; // –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ { img, name }
    let offX = 0, offY = 0, currentFrameIdx = 0;
    let pads = { top: 0, bottom: 0, left: 0, right: 0 };
    let animationTimer = null;
    let dragSrcEl = null;

    const canvas = document.getElementById('bgCanvasPreview');
    const ctx = canvas.getContext('2d');
    const loader = document.getElementById('loaderStatus');

    ['padTop','padBottom','padLeft','padRight'].forEach(id => {
        document.getElementById(id).oninput = (e) => {
            pads[id.replace('pad','').toLowerCase()] = parseInt(e.target.value) || 0;
            updateCanvasSize();
        };
    });

    document.getElementById('posX').oninput = e => offX = parseInt(e.target.value)||0;
    document.getElementById('posY').oninput = e => offY = parseInt(e.target.value)||0;

    function updateCanvasSize() {
        let w = 100, h = 100;
        if (bgImg) { w = bgImg.width; h = bgImg.height; }
        else if (loadedFrames.length > 0) { w = loadedFrames[0].img.width; h = loadedFrames[0].img.height; }
        canvas.width = w + pads.left + pads.right;
        canvas.height = h + pads.top + pads.bottom;
    }

    function setupZone(id, inId, cb) {
        const z = document.getElementById(id), i = document.getElementById(inId);
        z.onclick = () => i.click();
        z.ondragover = e => { e.preventDefault(); z.style.borderColor = "#007bff"; };
        z.ondragleave = () => z.style.borderColor = "#ccc";
        z.ondrop = e => { e.preventDefault(); z.style.borderColor = "#ccc"; cb(e.dataTransfer.files); };
        i.onchange = () => cb(i.files);
    }

    setupZone('dzBg', 'bgIn', async f => {
        loader.style.display = "block";
        bgImg = await loadImage(f[0]);
        updateCanvasSize();
        loader.style.display = "none";
        if (!animationTimer) startPreviewLoop();
    });

    setupZone('dzAnim', 'animIn', async f => {
        loader.style.display = "block";
        const sorted = Array.from(f).sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric:true}));
        for(let file of sorted) {
            const img = await loadImage(file);
            loadedFrames.push({ img, name: file.name });
        }
        updateCanvasSize();
        renderList();
        loader.style.display = "none";
        if (!animationTimer) startPreviewLoop();
    });

    function removeBg() { bgImg = null; updateCanvasSize(); }
    function clearAllFrames() { loadedFrames = []; renderList(); updateCanvasSize(); }
    function removeFrame(idx) { loadedFrames.splice(idx, 1); renderList(); updateCanvasSize(); }

    function startPreviewLoop() {
        if(animationTimer) clearTimeout(animationTimer);
        const loop = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (bgImg) ctx.drawImage(bgImg, pads.left, pads.top);
            if (loadedFrames.length > 0) {
                if (currentFrameIdx >= loadedFrames.length) currentFrameIdx = 0;
                const frame = loadedFrames[currentFrameIdx];
                ctx.drawImage(frame.img, offX + pads.left, offY + pads.top);
                ctx.strokeStyle = "rgba(0,123,255,0.6)"; ctx.lineWidth = 2;
                ctx.strokeRect(offX + pads.left, offY + pads.top, frame.img.width, frame.img.height);
                
                const delayInputs = document.querySelectorAll('.delay-input');
                const delayValue = delayInputs[currentFrameIdx] ? parseInt(delayInputs[currentFrameIdx].value) : 10;
                currentFrameIdx = (currentFrameIdx + 1) % loadedFrames.length;
                animationTimer = setTimeout(loop, Math.max(20, delayValue * 10));
            } else { animationTimer = setTimeout(loop, 100); }
        };
        loop();
    }

    function renderList() {
        const container = document.getElementById('fileList');
        container.innerHTML = loadedFrames.map((f, i) => `
            <div class="file-item" draggable="true" data-index="${i}">
                <span class="drag-handle">‚ò∞</span>
                <img src="${f.img.src}">
                <input type="number" class="delay-input" value="10" style="width:40px; border:1px solid #ccc; padding:2px; border-radius:3px;">
                <span style="flex-grow:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${f.name}</span>
                <button class="btn-del-small" onclick="removeFrame(${i})">üóëÔ∏è</button>
            </div>
        `).join('');
        
        // Drag-and-drop –ª–æ–≥–∏–∫–∞ —Å–ø–∏—Å–∫–∞
        const items = container.querySelectorAll('.file-item');
        items.forEach(item => {
            item.addEventListener('dragstart', handleDragStart);
            item.addEventListener('dragover', handleDragOver);
            item.addEventListener('drop', handleDrop);
            item.addEventListener('dragend', handleDragEnd);
        });
        document.getElementById('buildBtn').disabled = loadedFrames.length === 0;
    }

    // Drag and Drop —Å–æ–±—ã—Ç–∏—è
    function handleDragStart(e) { dragSrcEl = this; e.dataTransfer.effectAllowed = 'move'; this.classList.add('ghost'); }
    function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); return false; }
    function handleDrop(e) {
        if (e.stopPropagation) e.stopPropagation();
        if (dragSrcEl !== this) {
            const from = parseInt(dragSrcEl.dataset.index);
            const to = parseInt(this.dataset.index);
            const movedItem = loadedFrames.splice(from, 1)[0];
            loadedFrames.splice(to, 0, movedItem);
            renderList();
        }
        return false;
    }
    function handleDragEnd() { this.classList.remove('ghost'); }

    // –¢–æ—Ç –∂–µ Drag –Ω–∞ —Ö–æ–ª—Å—Ç–µ
    let isDraggingCanvas = false;
    canvas.onmousedown = () => isDraggingCanvas = true;
    window.onmouseup = () => isDraggingCanvas = false;
    canvas.onmousemove = (e) => {
        if (isDraggingCanvas && loadedFrames.length > 0) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const firstImg = loadedFrames[0].img;
            offX = Math.round((e.clientX - rect.left) * scaleX - pads.left - firstImg.width/2);
            offY = Math.round((e.clientY - rect.top) * scaleY - pads.top - firstImg.height/2);
            document.getElementById('posX').value = offX;
            document.getElementById('posY').value = offY;
        }
    };

    function applySMPreset() {
        const inputs = document.querySelectorAll('.delay-input');
        const count = loadedFrames.length;
        if (count !== 19 && count !== 20) return alert("–ù—É–∂–Ω–æ 19 –∏–ª–∏ 20 –∫–∞–¥—Ä–æ–≤!");
        inputs.forEach((input, i) => {
            const n = i+1; let d = 10;
            if (count === 19) {
                if([2,9,11,18].includes(n)) d=8; else if([3,4,5,6,7,8,12,13,14,15,16,17].includes(n)) d=16;
                else if(n===1) d=25; else if(n===19) d=66; else if(n===10) d=100;
            } else {
                if([2,6,7,10,12,19].includes(n)) d=8; else if([3,4,5,8,9,13,14,15,16,17,18].includes(n)) d=16;
                else if(n===1) d=25; else if(n===20) d=66; else if(n===11) d=100;
            }
            input.value = d;
        });
        document.getElementById('status').innerText = "–ü—Ä–µ—Å–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω!";
    }

    document.getElementById('buildBtn').onclick = async () => {
        const st = document.getElementById('status');
        st.innerText = "‚è≥ –°–±–æ—Ä–∫–∞...";
        try {
            const delays = Array.from(document.querySelectorAll('.delay-input')).map(i => (parseInt(i.value)||10)*10);
            const frames = [];
            const W = canvas.width, H = canvas.height;
            for (let f of loadedFrames) {
                const temp = document.createElement('canvas');
                temp.width = W; temp.height = H;
                const tCtx = temp.getContext('2d');
                if (bgImg) tCtx.drawImage(bgImg, pads.left, pads.top);
                tCtx.drawImage(f.img, offX + pads.left, offY + pads.top);
                frames.push(tCtx.getImageData(0,0,W,H).data.buffer);
            }
            const resBuf = UPNG.encode(frames, W, H, 0, delays);
            const blob = new Blob([resBuf], {type:"image/png"});
            document.getElementById('finalPreview').src = URL.createObjectURL(blob);
            document.getElementById('dlBtn').href = URL.createObjectURL(blob);
            document.getElementById('dlBtn').download = "medal.png";
            document.getElementById('finalSize').innerText = "–í–µ—Å: " + (blob.size/1024).toFixed(2) + " –ö–ë";
            document.getElementById('resultContainer').style.display = "block";
            document.getElementById('resultContainer').scrollIntoView({behavior:'smooth'});
            st.innerText = "‚úÖ –ì–æ—Ç–æ–≤–æ!";
        } catch (e) { st.innerText = "‚ùå –û—à–∏–±–∫–∞"; }
    };

    function loadImage(f) {
        return new Promise(res => {
            const i = new Image();
            i.onload = () => res(i);
            i.src = URL.createObjectURL(f);
        });
    }
</script>
</body>
</html>
