<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APNG Animated Positioner v2.1</title>
    <script src="https://cdn.jsdelivr.net/npm/pako@1.0.11/dist/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); width: 100%; max-width: 1100px; }
        .grid { display: grid; grid-template-columns: 340px 1fr; gap: 20px; }
        
        /* –°—Ç–∏–ª–∏ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ */
        .section { margin-bottom: 15px; padding: 12px; border: 1px solid #eef0f2; border-radius: 8px; background: #fafafa; }
        .drop-zone { border: 2px dashed #ccc; padding: 10px; text-align: center; border-radius: 8px; cursor: pointer; color: #777; font-size: 13px; transition: 0.3s; }
        .drop-zone.highlight { border-color: #007bff; background: #e7f3ff; }
        
        /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .controls-panel { background: #222; color: #fff; padding: 12px; border-radius: 8px; margin-bottom: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; box-sizing: border-box; }
        .controls-panel label { font-size: 11px; display: flex; flex-direction: column; gap: 4px; overflow: hidden; }
        .controls-panel input { 
            background: #444; 
            border: 1px solid #555; 
            color: #fff; 
            padding: 6px; 
            border-radius: 4px; 
            width: 100%; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é —à–∏—Ä–∏–Ω—É —è—á–µ–π–∫–∏ */
            box-sizing: border-box; /* –ß—Ç–æ–±—ã padding –Ω–µ —Ä–∞–∑–¥—É–≤–∞–ª —à–∏—Ä–∏–Ω—É */
            min-width: 0; /* –í–∞–∂–Ω–æ: –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–∂–∏–º–∞—Ç—å—Å—è –º–µ–Ω—å—à–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ */
        }

        .file-list { max-height: 200px; overflow-y: auto; border: 1px solid #eee; background: white; margin-top: 10px; }
        .file-item { display: flex; align-items: center; gap: 5px; padding: 4px; border-bottom: 1px solid #eee; font-size: 11px; }
        .file-item img { width: 25px; height: 25px; object-fit: contain; }
        
        /* –†–∞–±–æ—á–∞—è –æ–±–ª–∞—Å—Ç—å */
        #workArea { position: relative; background: #333; border-radius: 8px; overflow: auto; display: flex; align-items: center; justify-content: center; min-height: 450px; border: 2px solid #444; }
        #bgCanvasPreview { background-color: #fff; background-image: linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%, #eee), linear-gradient(45deg, #eee 25%, white 25%, white 75%, #eee 75%, #eee); background-size: 20px 20px; background-position: 0 0, 10px 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5); cursor: move; }
        
        .btn { border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px; }
        .btn-preset { background: #6f42c1; color: white; }
        .btn-build { background: #28a745; color: white; font-size: 16px; margin-top: 15px; }
        
        /* –†–µ–∑—É–ª—å—Ç–∞—Ç */
        #resultContainer { margin-top: 20px; padding: 20px; border: 2px solid #28a745; border-radius: 8px; background: #f6fff6; display: none; }
        #finalPreview { max-width: 100%; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 1px solid #ccc; background: white; }
        .download-btn { display: inline-block; margin-top: 15px; background: #007bff; color: white; padding: 12px 25px; text-decoration: none; border-radius: 6px; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <div class="grid">
        <div class="sidebar">
            <h3 style="margin-top:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ APNG</h3>
            <div class="section">
                <div id="dzBg" class="drop-zone">üì• –í—ã–±—Ä–∞—Ç—å —Ñ–æ–Ω</div>
                <input type="file" id="bgIn" style="display:none">
                <div id="dzAnim" class="drop-zone" style="margin-top:5px;">üì• –í—ã–±—Ä–∞—Ç—å –∫–∞–¥—Ä—ã</div>
                <input type="file" id="animIn" multiple style="display:none">
            </div>

            <div class="controls-panel">
                <div style="grid-column: 1/3; font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px;">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è (px)</div>
                <label>–°–≤–µ—Ä—Ö—É <input type="number" id="padTop" value="0"></label>
                <label>–°–Ω–∏–∑—É <input type="number" id="padBottom" value="0"></label>
                <label>–°–ª–µ–≤–∞ <input type="number" id="padLeft" value="0"></label>
                <label>–°–ø—Ä–∞–≤–∞ <input type="number" id="padRight" value="0"></label>
                <div style="grid-column: 1/3; height: 1px; background: #444; margin: 4px 0;"></div>
                <div style="grid-column: 1/3; font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px;">–ü–æ–∑–∏—Ü–∏—è –º–µ–¥–∞–ª–∏</div>
                <label>–°–º–µ—â–µ–Ω–∏–µ X <input type="number" id="posX" value="0"></label>
                <label>–°–º–µ—â–µ–Ω–∏–µ Y <input type="number" id="posY" value="0"></label>
            </div>

            <div class="file-list" id="fileList"></div>
            <button class="btn btn-preset" onclick="applySMPreset()">–ü—Ä–µ—Å–µ—Ç "–°–ú –ú–µ–¥–∞–ª–∏"</button>
            <button class="btn btn-build" id="buildBtn" disabled>–°–û–ë–†–ê–¢–¨ APNG</button>
            <div id="status" style="margin-top:10px; text-align:center; font-size: 14px; font-weight:bold;"></div>
        </div>

        <div class="main">
            <div id="workArea">
                <canvas id="bgCanvasPreview"></canvas>
            </div>
            
            <div id="resultContainer">
                <h3 style="margin-top:0">‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</h3>
                <div id="finalSize" style="margin-bottom:10px; font-weight:bold; color: #28a745;"></div>
                <img id="finalPreview">
                <br>
                <a id="dlBtn" class="download-btn">–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª (.png)</a>
            </div>
        </div>
    </div>
</div>

<script>
    let animationFiles = [], bgImg = null, loadedFrames = [];
    let offX = 0, offY = 0, currentFrameIdx = 0;
    let pads = { top: 0, bottom: 0, left: 0, right: 0 };
    let animationTimer = null;

    const canvas = document.getElementById('bgCanvasPreview');
    const ctx = canvas.getContext('2d');

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª–µ–π
    ['padTop','padBottom','padLeft','padRight'].forEach(id => {
        document.getElementById(id).oninput = (e) => {
            pads[id.replace('pad','').toLowerCase()] = parseInt(e.target.value) || 0;
            updateCanvasSize();
        };
    });

    document.getElementById('posX').oninput = e => { offX = parseInt(e.target.value)||0; };
    document.getElementById('posY').oninput = e => { offY = parseInt(e.target.value)||0; };

    function updateCanvasSize() {
        if (!bgImg) return;
        canvas.width = bgImg.width + pads.left + pads.right;
        canvas.height = bgImg.height + pads.top + pads.bottom;
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞
    setupZone('dzBg', 'bgIn', async f => {
        bgImg = await loadImage(f[0]);
        updateCanvasSize();
        if (!animationTimer) startPreviewLoop();
    });

    setupZone('dzAnim', 'animIn', async f => {
        const sorted = Array.from(f).sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric:true}));
        animationFiles = animationFiles.concat(sorted);
        loadedFrames = await Promise.all(animationFiles.map(file => loadImage(file)));
        renderList();
        if (bgImg && !animationTimer) startPreviewLoop();
    });

    function setupZone(id, inId, cb) {
        const z = document.getElementById(id), i = document.getElementById(inId);
        z.onclick = () => i.click();
        z.ondragover = e => { e.preventDefault(); z.classList.add('highlight'); };
        z.ondragleave = () => z.classList.remove('highlight');
        z.ondrop = e => { e.preventDefault(); z.classList.remove('highlight'); cb(e.dataTransfer.files); };
        i.onchange = () => cb(i.files);
    }

    function startPreviewLoop() {
        const loop = () => {
            if (!bgImg) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(bgImg, pads.left, pads.top);
            if (loadedFrames.length > 0) {
                const img = loadedFrames[currentFrameIdx];
                ctx.drawImage(img, offX + pads.left, offY + pads.top);
                ctx.strokeStyle = "rgba(0,123,255,0.6)";
                ctx.lineWidth = 2;
                ctx.strokeRect(offX + pads.left, offY + pads.top, img.width, img.height);
                const delayInputs = document.querySelectorAll('.delay-input');
                const delay = (delayInputs[currentFrameIdx] ? parseInt(delayInputs[currentFrameIdx].value) : 10) * 10;
                currentFrameIdx = (currentFrameIdx + 1) % loadedFrames.length;
                animationTimer = setTimeout(loop, Math.max(20, delay));
            } else {
                animationTimer = setTimeout(loop, 100);
            }
        };
        loop();
    }

    let isDragging = false;
    canvas.onmousedown = () => isDragging = true;
    window.onmouseup = () => isDragging = false;
    canvas.onmousemove = (e) => {
        if (isDragging && loadedFrames.length > 0) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const firstImg = loadedFrames[0];
            offX = Math.round((e.clientX - rect.left) * scaleX - pads.left - firstImg.width/2);
            offY = Math.round((e.clientY - rect.top) * scaleY - pads.top - firstImg.height/2);
            document.getElementById('posX').value = offX;
            document.getElementById('posY').value = offY;
        }
    };

    function renderList() {
        document.getElementById('fileList').innerHTML = animationFiles.map((f, i) => `
            <div class="file-item">
                <b style="width:20px">${i+1}</b>
                <input type="number" class="delay-input" value="10" style="width:45px; border:1px solid #ccc; padding:2px; border-radius:3px;">
                <span style="flex-grow:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${f.name}</span>
            </div>
        `).join('');
        document.getElementById('buildBtn').disabled = !bgImg || animationFiles.length === 0;
    }

    function applySMPreset() {
        const inputs = document.querySelectorAll('.delay-input');
        const count = animationFiles.length;
        if (count !== 19 && count !== 20) return alert("–ù—É–∂–Ω–æ 19 –∏–ª–∏ 20 –∫–∞–¥—Ä–æ–≤!");
        inputs.forEach((input, i) => {
            const n = i+1; let d = 10;
            if (count === 19) {
                if([2,9,11,18].includes(n)) d=8; else if([3,4,5,6,7,8,12,13,14,15,16,17].includes(n)) d=16;
                else if(n===1) d=25; else if(n===19) d=66; else if(n===10) d=100;
            } else {
                if([2,6,7,10,12,19].includes(n)) d=8; else if([3,4,5,8,9,13,14,15,16,17,18].includes(n)) d=16;
                else if(n===1) d=25; else if(n===20) d=66; else if(n===11) d=100;
            }
            input.value = d;
        });
        document.getElementById('status').innerText = "–ü—Ä–µ—Å–µ—Ç —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω!";
        document.getElementById('status').style.color = "purple";
    }

    document.getElementById('buildBtn').onclick = async () => {
        const st = document.getElementById('status');
        st.innerText = "‚è≥ –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞...";
        st.style.color = "orange";
        try {
            const delays = Array.from(document.querySelectorAll('.delay-input')).map(i => (parseInt(i.value)||10)*10);
            const frames = [];
            const W = canvas.width, H = canvas.height;
            for (let img of loadedFrames) {
                const temp = document.createElement('canvas');
                temp.width = W; temp.height = H;
                const tCtx = temp.getContext('2d');
                tCtx.drawImage(bgImg, pads.left, pads.top);
                tCtx.drawImage(img, offX + pads.left, offY + pads.top);
                frames.push(tCtx.getImageData(0,0,W,H).data.buffer);
            }
            const resBuf = UPNG.encode(frames, W, H, 0, delays);
            const blob = new Blob([resBuf], {type:"image/png"});
            const url = URL.createObjectURL(blob);
            document.getElementById('finalPreview').src = url;
            document.getElementById('dlBtn').href = url;
            document.getElementById('dlBtn').download = "result.png";
            document.getElementById('finalSize').innerText = "–í–µ—Å —Ñ–∞–π–ª–∞: " + (blob.size/1024).toFixed(2) + " –ö–ë";
            document.getElementById('resultContainer').style.display = "block";
            document.getElementById('resultContainer').scrollIntoView({behavior:'smooth'});
            st.innerText = "‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω!";
            st.style.color = "green";
        } catch (e) { 
            st.innerText = "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ"; 
            st.style.color = "red";
        }
    };

    function loadImage(f) {
        return new Promise(res => {
            const i = new Image();
            i.onload = () => res(i);
            i.src = URL.createObjectURL(f);
        });
    }
</script>
</body>
</html>
