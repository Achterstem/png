<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APNG || GIF Maker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/1.0.11/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gifshot@0.4.5/build/gifshot.min.js"></script>
    <style>
        :root {
            --bg-color: #0a0a0a;
            --card-bg: #141414;
            --border-color: #2d2d2d;
            --text-main: #e0e0e0;
            --text-dim: #888;
            --accent-white: #ffffff;
            --input-bg: #1f1f1f;
            --hover-bg: #2a2a2a;
        }

        body { 
            font-family: -apple-system, system-ui, sans-serif; 
            background: var(--bg-color); 
            color: var(--text-main);
            padding: 20px; 
            display: flex; 
            justify-content: center; 
            margin: 0;
        }
        
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        .card { 
            background: var(--card-bg); 
            padding: 25px; 
            border-radius: 12px; 
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); 
            width: 100%; 
            max-width: 1100px; 
        }

        .grid { display: grid; grid-template-columns: 360px 1fr; gap: 20px; }
        
        .section { 
            margin-bottom: 15px; 
            padding: 12px; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            background: #1a1a1a; 
        }

        .drop-row { display: flex; gap: 5px; margin-bottom: 5px; }
        
        .drop-zone { 
            border: 1px dashed #444; 
            padding: 10px; 
            text-align: center; 
            border-radius: 8px; 
            cursor: pointer; 
            color: var(--text-dim); 
            font-size: 13px; 
            flex-grow: 1; 
            transition: all 0.2s; 
        }
        .drop-zone:hover { border-color: var(--accent-white); color: var(--accent-white); background: var(--hover-bg); }

        .btn-del-small { 
            background: #1a1a1a; 
            border: 1px solid #444; 
            border-radius: 8px; 
            cursor: pointer; 
            padding: 0 12px; 
            color: var(--text-main); 
            transition: 0.2s; 
        }
        .btn-del-small:hover { background: #333; border-color: #888; }

        .controls-panel { 
            background: #000; 
            color: #fff; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            border: 1px solid var(--border-color);
        }
        .controls-panel label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); display: flex; flex-direction: column; gap: 5px; }
        .controls-panel input { 
            background: var(--input-bg); 
            border: 1px solid #333; 
            color: #fff; 
            padding: 8px; 
            border-radius: 4px; 
            width: 100%; 
            box-sizing: border-box; 
            text-align: center;
        }

        .file-list { 
            max-height: 300px; 
            overflow-y: auto; 
            border: 1px solid var(--border-color); 
            background: #000; 
            margin-top: 10px; 
            border-radius: 6px; 
        }
        .file-item { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            padding: 8px; 
            border-bottom: 1px solid var(--border-color); 
            font-size: 11px; 
            cursor: grab; 
            background: #111;
        }
        .file-item.ghost { opacity: 0.3; background: #222; }
        .file-item img { width: 35px; height: 35px; object-fit: contain; border: 1px solid #333; background: #fff; border-radius: 4px; }
        .file-item .drag-handle { color: #444; }
        .file-item input { background: #222; border: 1px solid #444; color: #fff; text-align: center; }
        
        #workArea { 
            position: relative; 
            background: #050505; 
            border-radius: 8px; 
            overflow: auto; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 450px; 
            border: 1px solid var(--border-color); 
        }
        
        #bgCanvasPreview { 
            background-color: #fff; 
            background-image: 
                linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%, #eee), 
                linear-gradient(45deg, #eee 25%, white 25%, white 75%, #eee 75%, #eee); 
            background-size: 20px 20px; 
            background-position: 0 0, 10px 10px;
            box-shadow: 0 0 30px rgba(0,0,0,0.8); 
            cursor: move; 
        }
        
        .btn { border: 1px solid #444; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px; transition: 0.2s; }
        .btn-preset { background: #1a1a1a; color: var(--text-main); }
        .btn-preset:hover { background: #252525; border-color: #666; }
        
        .btn-build { background: var(--accent-white); color: #000; font-size: 14px; margin-top: 15px; border: none; text-transform: uppercase; letter-spacing: 1px; }
        .btn-build:hover { background: #ccc; }
        .btn-build:disabled { background: #333; color: #666; }
        
        #status { margin-top: 10px; text-align: center; font-size: 12px; letter-spacing: 1px; min-height: 1.2em; color: var(--text-dim); }
        #loaderStatus { color: var(--text-main); font-size: 11px; text-align: center; margin-top: 5px; display: none; text-transform: uppercase; }

        #resultContainer { 
            margin-top: 25px; 
            padding: 20px; 
            border: 1px solid var(--accent-white); 
            border-radius: 8px; 
            background: #000; 
            display: none; 
            text-align: center;
        }
        #finalPreview { max-width: 100%; border: 1px solid #333; background: white; margin-bottom: 15px; }
        
        .download-btn { 
            display: inline-block; 
            background: var(--accent-white); 
            color: #000; 
            padding: 12px 30px; 
            text-decoration: none; 
            border-radius: 4px; 
            font-weight: bold; 
            text-transform: uppercase; 
            font-size: 12px;
        }
    </style>
</head>
<body>

<div class="card">
    <div class="grid">
        <div class="sidebar">
            <h3 style="margin-top:0; letter-spacing: 2px; text-transform: uppercase; font-size: 18px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">APNG & GIF Maker</h3>
            <div class="section">
                <div class="drop-row">
                    <div id="dzBg" class="drop-zone">–í–´–ë–†–ê–¢–¨ –§–û–ù (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</div>
                    <button class="btn-del-small" onclick="removeBg()">üóë</button>
                </div>
                <div class="drop-row">
                    <div id="dzAnim" class="drop-zone">–í–´–ë–†–ê–¢–¨ –ö–ê–î–†–´</div>
                    <button class="btn-del-small" onclick="clearAllFrames()">üóë</button>
                </div>
                <input type="file" id="bgIn" style="display:none">
                <input type="file" id="animIn" multiple style="display:none">
            </div>

            <div class="controls-panel">
                <label>–í–µ—Ä—Ö <input type="number" id="padTop" value="0"></label>
                <label>–ù–∏–∑ <input type="number" id="padBottom" value="0"></label>
                <label>–õ–µ–≤–æ <input type="number" id="padLeft" value="0"></label>
                <label>–ü—Ä–∞–≤–æ <input type="number" id="padRight" value="0"></label>
                <label>X Pos <input type="number" id="posX" value="0"></label>
                <label>Y Pos <input type="number" id="posY" value="0"></label>
            </div>

            <div class="file-list" id="fileList"></div>
            
            <button class="btn btn-preset" onclick="applySMPreset()">–ü–†–ï–°–ï–¢: –°–ú –ú–ï–î–ê–õ–¨</button>
            <button class="btn btn-build" id="buildBtn" disabled>–°–ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨ APNG</button>
            <button class="btn btn-build" id="gifBtn" disabled>–°–ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨ GIF</button>
            
            <div id="loaderStatus">LOADING...</div>
            <div id="status"></div>
        </div>

        <div class="main">
            <div id="workArea">
                <canvas id="bgCanvasPreview"></canvas>
            </div>
            
            <div id="resultContainer">
                <img id="finalPreview">
                <div id="finalSize" style="margin-bottom:15px; font-size: 11px; color: #888;"></div>
                <a id="dlBtn" class="download-btn">–°–ö–ê–ß–ê–¢–¨ –§–ê–ô–õ</a>
            </div>
        </div>
    </div>
</div>

<script>
    let bgImg = null;
    let loadedFrames = [];
    let offX = 0, offY = 0, currentFrameIdx = 0;
    let pads = { top: 0, bottom: 0, left: 0, right: 0 };
    let animationTimer = null;

    const canvas = document.getElementById('bgCanvasPreview');
    const ctx = canvas.getContext('2d');
    const loader = document.getElementById('loaderStatus');

    ['padTop','padBottom','padLeft','padRight'].forEach(id => {
        document.getElementById(id).oninput = (e) => {
            pads[id.replace('pad','').toLowerCase()] = parseInt(e.target.value) || 0;
            updateCanvasSize();
        };
    });

    document.getElementById('posX').oninput = e => offX = parseInt(e.target.value)||0;
    document.getElementById('posY').oninput = e => offY = parseInt(e.target.value)||0;

    function updateCanvasSize() {
        let w = 100, h = 100;
        if (bgImg) { w = bgImg.width; h = bgImg.height; }
        else if (loadedFrames.length > 0) { w = loadedFrames[0].img.width; h = loadedFrames[0].img.height; }
        canvas.width = w + pads.left + pads.right;
        canvas.height = h + pads.top + pads.bottom;
    }

    function setupZone(id, inId, cb) {
        const z = document.getElementById(id), i = document.getElementById(inId);
        z.onclick = () => i.click();
        z.ondragover = e => { e.preventDefault(); z.style.borderColor = "#fff"; };
        z.ondragleave = () => z.style.borderColor = "#444";
        z.ondrop = e => { e.preventDefault(); z.style.borderColor = "#444"; cb(e.dataTransfer.files); };
        i.onchange = () => cb(i.files);
    }

    setupZone('dzBg', 'bgIn', async f => {
        if(!f.length) return;
        loader.style.display = "block";
        bgImg = await loadImage(f[0]);
        updateCanvasSize();
        loader.style.display = "none";
        if (!animationTimer) startPreviewLoop();
    });

    setupZone('dzAnim', 'animIn', async f => {
        if(!f.length) return;
        loader.style.display = "block";
        const sorted = Array.from(f).sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric:true}));
        for(let file of sorted) {
            const img = await loadImage(file);
            loadedFrames.push({ img, name: file.name, delay: 10 });
        }
        updateCanvasSize(); renderList();
        loader.style.display = "none";
        if (!animationTimer) startPreviewLoop();
    });

    function removeBg() { bgImg = null; updateCanvasSize(); }
    function clearAllFrames() { loadedFrames = []; renderList(); updateCanvasSize(); }
    function removeFrame(idx) { loadedFrames.splice(idx, 1); renderList(); updateCanvasSize(); }

    function startPreviewLoop() {
        const loop = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (bgImg) ctx.drawImage(bgImg, pads.left, pads.top);
            if (loadedFrames.length > 0) {
                if (currentFrameIdx >= loadedFrames.length) currentFrameIdx = 0;
                ctx.drawImage(loadedFrames[currentFrameIdx].img, offX + pads.left, offY + pads.top);
                const delay = parseInt(document.querySelectorAll('.delay-input')[currentFrameIdx]?.value) || 10;
                currentFrameIdx = (currentFrameIdx + 1) % loadedFrames.length;
                animationTimer = setTimeout(loop, delay * 10);
            } else { animationTimer = setTimeout(loop, 100); }
        };
        loop();
    }

    function renderList() {
        const container = document.getElementById('fileList');
        container.innerHTML = loadedFrames.map((f, i) => `
            <div class="file-item">
                <img src="${f.img.src}">
                <input type="number" class="delay-input" value="${f.delay || 10}" style="width:35px">
                <span style="flex-grow:1; font-size:10px">${f.name}</span>
                <button onclick="removeFrame(${i})">√ó</button>
            </div>
        `).join('');
        document.getElementById('buildBtn').disabled = loadedFrames.length === 0;
        document.getElementById('gifBtn').disabled = loadedFrames.length === 0;
    }

    // –°–ë–û–†–ö–ê APNG
    document.getElementById('buildBtn').onclick = async () => {
        const st = document.getElementById('status');
        st.innerText = "PROCESSING APNG...";
        try {
            const delays = Array.from(document.querySelectorAll('.delay-input')).map(i => (parseInt(i.value)||10)*10);
            const frames = [];
            for (let f of loadedFrames) {
                const temp = document.createElement('canvas');
                temp.width = canvas.width; temp.height = canvas.height;
                const tCtx = temp.getContext('2d');
                if (bgImg) tCtx.drawImage(bgImg, pads.left, pads.top);
                tCtx.drawImage(f.img, offX + pads.left, offY + pads.top);
                frames.push(tCtx.getImageData(0,0,canvas.width,canvas.height).data.buffer);
            }
            const resBuf = UPNG.encode(frames, canvas.width, canvas.height, 0, delays);
            const blob = new Blob([resBuf], {type:"image/png"});
            showResult(blob, "output.png");
            st.innerText = "SUCCESS (APNG)";
        } catch (e) { st.innerText = "ERROR"; }
    };

    // –°–ë–û–†–ö–ê GIF (–õ–ï–ì–ö–ò–ô –°–ü–û–°–û–ë)
    document.getElementById('gifBtn').onclick = async () => {
        const st = document.getElementById('status');
        st.innerText = "PROCESSING GIF (LOW CPU)...";
        try {
            const images = [];
            for (let f of loadedFrames) {
                const temp = document.createElement('canvas');
                temp.width = canvas.width; temp.height = canvas.height;
                const tCtx = temp.getContext('2d');
                if (bgImg) tCtx.drawImage(bgImg, pads.left, pads.top);
                tCtx.drawImage(f.img, offX + pads.left, offY + pads.top);
                images.push(temp.toDataURL('image/png'));
            }
            
            gifshot.createGIF({
                images: images,
                gifWidth: canvas.width,
                gifHeight: canvas.height,
                interval: (parseInt(document.querySelector('.delay-input').value) || 10) / 100,
                numWorkers: 1, // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
                sampleInterval: 5 // –ë–∞–ª–∞–Ω—Å –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —Å–∫–æ—Ä–æ—Å—Ç–∏
            }, function(obj) {
                if(!obj.error) {
                    document.getElementById('finalPreview').src = obj.image;
                    document.getElementById('dlBtn').href = obj.image;
                    document.getElementById('dlBtn').download = "output.gif";
                    document.getElementById('resultContainer').style.display = "block";
                    st.innerText = "SUCCESS (GIF)";
                }
            });
        } catch (e) { st.innerText = "ERROR"; }
    };

    function showResult(blob, name) {
        const url = URL.createObjectURL(blob);
        document.getElementById('finalPreview').src = url;
        document.getElementById('dlBtn').href = url;
        document.getElementById('dlBtn').download = name;
        document.getElementById('finalSize').innerText = (blob.size/1024).toFixed(2) + " KB";
        document.getElementById('resultContainer').style.display = "block";
    }

    function applySMPreset() {
        const inputs = document.querySelectorAll('.delay-input');
        if (inputs.length < 19) return alert("–ù—É–∂–Ω–æ 19-20 –∫–∞–¥—Ä–æ–≤");
        inputs.forEach((input, i) => {
            let d = 10;
            if (i === 0) d = 25;
            else if (i === 9) d = 100;
            else if (i === 18) d = 66;
            input.value = d;
        });
    }

    function loadImage(f) {
        return new Promise(res => {
            const i = new Image();
            i.onload = () => res(i);
            i.src = URL.createObjectURL(f);
        });
    }
</script>
</body>
</html>
