<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APNG Medal Master Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/pako@1.0.11/dist/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); width: 100%; max-width: 650px; }
        h2 { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 20px; display: flex; justify-content: space-between; align-items: center; }
        .section { margin-bottom: 15px; padding: 12px; border: 1px solid #eef0f2; border-radius: 8px; }
        .section-title { font-weight: bold; margin-bottom: 8px; display: block; color: #555; }
        .drop-zone { border: 2px dashed #ccc; padding: 15px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.3s; color: #777; font-size: 14px; }
        .drop-zone.highlight { border-color: #007bff; background: #e7f3ff; }
        .file-list { margin-top: 10px; max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; }
        .file-item { display: flex; align-items: center; gap: 8px; background: #fff; padding: 5px 10px; border-bottom: 1px solid #eee; font-size: 13px; }
        .file-item img { width: 32px; height: 32px; object-fit: contain; background: #eee; border-radius: 4px; }
        .file-item input { width: 50px; padding: 3px; border: 1px solid #ddd; text-align: center; border-radius: 4px; }
        .controls-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn { border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-preset { background: #6f42c1; color: white; flex-grow: 2; }
        .btn-clear { background: #dc3545; color: white; flex-grow: 1; }
        #buildBtn { width: 100%; background: #28a745; color: white; padding: 15px; border-radius: 8px; font-size: 16px; margin-top: 10px; }
        #buildBtn:disabled { background: #ccc; cursor: not-allowed; }
        #resultContainer { margin-top: 20px; text-align: center; display: none; border-top: 2px solid #eee; padding-top: 15px; }
        .weight-info { font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #28a745; }
        #preview { border: 1px solid #ddd; background: #fff; margin-bottom: 10px; }
        .download-btn { display: inline-block; background: #007bff; color: white; text-decoration: none; padding: 12px 24px; border-radius: 6px; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h2>–°–±–æ—Ä—â–∏–∫ APNG <span>v2.1</span></h2>
    
    <div class="section">
        <span class="section-title">1. –°—Ç–∞—Ç–∏—á–Ω—ã–π —Ñ–æ–Ω (–ª—é–±–æ–π —Ä–∞–∑–º–µ—Ä)</span>
        <div id="dropZoneBg" class="drop-zone" style="background: #fffcf0;">
            –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ–Ω —Å—é–¥–∞
            <input type="file" id="bgInput" accept="image/png, image/jpeg" style="display:none">
        </div>
        <div id="bgPreviewContainer" style="display:none; align-items: center; gap: 10px; margin-top: 8px;">
            <img id="bgThumb" style="height: 35px; border: 1px solid #ccc;">
            <span id="bgName" style="font-size: 12px; color: #666;"></span>
            <button onclick="clearBg()" style="cursor:pointer; border:none; background:none;">‚ùå</button>
        </div>
    </div>

    <div class="section">
        <span class="section-title">2. –ö–∞–¥—Ä—ã –∞–Ω–∏–º–∞—Ü–∏–∏</span>
        <div id="dropZoneAnim" class="drop-zone" style="background: #f8f9fa;">
            –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã –∫–∞–¥—Ä–æ–≤ —Å—é–¥–∞
            <input type="file" id="fileInput" multiple accept="image/png" style="display:none">
        </div>
        <div id="fileList" class="file-list"></div>
    </div>

    <div class="controls-row">
        <button class="btn btn-preset" id="presetBtn" onclick="applySMPreset()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–µ—Å–µ—Ç "–°–ú –º–µ–¥–∞–ª–∏"</button>
        <button class="btn btn-clear" onclick="clearAll()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
    </div>

    <button id="buildBtn" class="btn" disabled>–°–æ–±—Ä–∞—Ç—å APNG</button>
    <div id="status" style="text-align:center; margin-top:10px; font-weight:bold;"></div>

    <div id="resultContainer">
        <div class="weight-info" id="finalSize">–í–µ—Å: 0 –ö–ë</div>
        <img id="preview" alt="Preview"><br>
        <a id="downloadLink" class="download-btn">–°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</a>
    </div>
</div>

<script>
    let animationFiles = [];
    let bgFile = null;
    let isPresetActive = false;

    setupZone('dropZoneBg', 'bgInput', f => {
        bgFile = f[0];
        document.getElementById('bgThumb').src = URL.createObjectURL(bgFile);
        document.getElementById('bgName').innerText = bgFile.name;
        document.getElementById('bgPreviewContainer').style.display = 'flex';
    });
    
    setupZone('dropZoneAnim', 'fileInput', f => {
        const newFiles = Array.from(f);
        animationFiles = animationFiles.concat(newFiles);
        animationFiles.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'}));
        renderList();
    });

    function setupZone(id, inputId, cb) {
        const z = document.getElementById(id), i = document.getElementById(inputId);
        z.onclick = () => i.click();
        z.ondragover = e => { e.preventDefault(); z.classList.add('highlight'); };
        z.ondragleave = () => z.classList.remove('highlight');
        z.ondrop = e => { e.preventDefault(); z.classList.remove('highlight'); cb(e.dataTransfer.files); };
        i.onchange = () => cb(i.files);
    }

    function renderList() {
        const c = document.getElementById('fileList');
        c.innerHTML = animationFiles.map((f, i) => `
            <div class="file-item">
                <b style="color:#888; width:20px;">${i+1}</b>
                <img src="${URL.createObjectURL(f)}">
                <div style="flex-grow:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${f.name}</div>
                <input type="number" class="delay-input" value="10"> <small>1/100s</small>
                <button onclick="removeF(${i})" style="border:none; background:none; cursor:pointer;">üóëÔ∏è</button>
            </div>
        `).join('');
        document.getElementById('buildBtn').disabled = animationFiles.length === 0;
    }

    function removeF(i) { animationFiles.splice(i, 1); renderList(); }
    function clearBg() { bgFile = null; document.getElementById('bgInput').value = ''; document.getElementById('bgPreviewContainer').style.display = 'none'; }
    function clearAll() { animationFiles = []; isPresetActive = false; clearBg(); renderList(); document.getElementById('resultContainer').style.display = 'none'; document.getElementById('status').innerText = ''; }

    function applySMPreset() {
        const count = animationFiles.length;
        if (count !== 19 && count !== 20) {
            alert(`–î–ª—è –ø—Ä–µ—Å–µ—Ç–∞ –Ω—É–∂–Ω–æ 19 –∏–ª–∏ 20 –∫–∞–¥—Ä–æ–≤. –£ –≤–∞—Å: ${count}`);
            return;
        }
        const inputs = document.querySelectorAll('.delay-input');
        inputs.forEach((input, index) => {
            const n = index + 1;
            let d = 10;
            if (count === 19) {
                if ([2,9,11,18].includes(n)) d = 8;
                else if ([3,4,5,6,7,8,12,13,14,15,16,17].includes(n)) d = 16;
                else if (n === 1) d = 25;
                else if (n === 19) d = 66;
                else if (n === 10) d = 100;
            } else {
                if ([2,6,7,10,12,19].includes(n)) d = 8;
                else if ([3,4,5,8,9,13,14,15,16,17,18].includes(n)) d = 16;
                else if (n === 1) d = 25;
                else if (n === 20) d = 66;
                else if (n === 11) d = 100;
            }
            input.value = d;
        });
        isPresetActive = true;
        showStatus("–ü—Ä–µ—Å–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω. –®–∏—Ä–∏–Ω–∞ –±—É–¥–µ—Ç —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ (–µ—Å–ª–∏ 40px).", "purple");
    }

    function showStatus(txt, color) {
        const s = document.getElementById('status');
        s.innerText = txt; s.style.color = color;
    }

    document.getElementById('buildBtn').onclick = async () => {
        const btn = document.getElementById('buildBtn');
        showStatus("‚è≥ –°–±–æ—Ä–∫–∞...", "orange");
        btn.disabled = true;

        try {
            const delays = Array.from(document.querySelectorAll('.delay-input')).map(i => (parseInt(i.value) || 10) * 10);
            const framesData = [];
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –±–∞–∑–æ–≤–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
            const firstImg = await loadImage(animationFiles[0]);
            let targetW = firstImg.width;
            let targetH = firstImg.height;

            // –ï—Å–ª–∏ –ø—Ä–µ—Å–µ—Ç –∞–∫—Ç–∏–≤–µ–Ω –∏ —à–∏—Ä–∏–Ω–∞ 40, —Ä–∞—Å—à–∏—Ä—è–µ–º –¥–æ 41
            if (isPresetActive && targetW === 40) {
                targetW = 41;
            }

            let bgImg = bgFile ? await loadImage(bgFile) : null;

            for (let i = 0; i < animationFiles.length; i++) {
                const img = await loadImage(animationFiles[i]);
                const canvas = document.createElement('canvas');
                canvas.width = targetW;
                canvas.height = targetH;
                const ctx = canvas.getContext('2d');

                // –†–∏—Å—É–µ–º —Ñ–æ–Ω (–µ—Å–ª–∏ –µ—Å—Ç—å)
                if (bgImg) {
                    ctx.drawImage(bgImg, 0, 0);
                }
                
                // –†–∏—Å—É–µ–º –∫–∞–¥—Ä
                ctx.drawImage(img, 0, 0);
                
                framesData.push(ctx.getImageData(0, 0, targetW, targetH).data.buffer);
            }

            const resBuf = UPNG.encode(framesData, targetW, targetH, 0, delays);
            const blob = new Blob([resBuf], { type: "image/png" });
            const url = URL.createObjectURL(blob);
            
            document.getElementById('preview').src = url;
            document.getElementById('downloadLink').href = url;
            document.getElementById('downloadLink').download = `apng_result_${Date.now()}.png`;
            document.getElementById('finalSize').innerText = `–í–µ—Å: ${(blob.size / 1024).toFixed(2)} –ö–ë | –†–∞–∑–º–µ—Ä: ${targetW}x${targetH}`;
            document.getElementById('resultContainer').style.display = "block";
            showStatus("‚úÖ –ì–æ—Ç–æ–≤–æ!", "green");
        } catch (e) {
            showStatus("‚ùå –û—à–∏–±–∫–∞: " + e.message, "red");
        } finally { btn.disabled = false; }
    };

    function loadImage(file) {
        return new Promise((res, rej) => {
            const img = new Image();
            img.onload = () => res(img);
            img.onerror = rej;
            img.src = URL.createObjectURL(file);
        });
    }
</script>
</body>
</html>
