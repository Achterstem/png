<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APNG Visual Positioner</title>
    <script src="https://cdn.jsdelivr.net/npm/pako@1.0.11/dist/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); width: 100%; max-width: 800px; }
        .section { margin-bottom: 15px; padding: 12px; border: 1px solid #eef0f2; border-radius: 8px; }
        .drop-zone { border: 2px dashed #ccc; padding: 15px; text-align: center; border-radius: 8px; cursor: pointer; color: #777; }
        .drop-zone.highlight { border-color: #007bff; background: #e7f3ff; }
        
        /* Контейнер для визуальной настройки */
        #workArea { position: relative; margin: 20px 0; background: #eee; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; min-height: 200px; cursor: crosshair; }
        #bgCanvasPreview { box-shadow: 0 0 10px rgba(0,0,0,0.2); background: white; }
        
        .controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .file-list { max-height: 200px; overflow-y: auto; border: 1px solid #eee; margin-bottom: 15px; }
        .file-item { display: flex; align-items: center; gap: 8px; padding: 5px; border-bottom: 1px solid #eee; font-size: 12px; }
        .file-item img { width: 30px; height: 30px; object-fit: contain; }
        
        .btn { border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-preset { background: #6f42c1; color: white; }
        .btn-build { background: #28a745; color: white; width: 100%; font-size: 16px; }
        
        #posControls { background: #333; color: white; padding: 10px; border-radius: 6px; display: flex; gap: 15px; align-items: center; margin-bottom: 10px; }
        input[type="number"] { width: 60px; }
    </style>
</head>
<body>

<div class="card">
    <h2>Сборщик APNG: Настройка позиции</h2>

    <div class="controls-grid">
        <div class="section">
            <span class="section-title">1. Фон (любой размер)</span>
            <div id="dzBg" class="drop-zone">Клик или Drag фон<input type="file" id="bgIn" style="display:none"></div>
        </div>
        <div class="section">
            <span class="section-title">2. Кадры анимации</span>
            <div id="dzAnim" class="drop-zone">Клик или Drag кадры<input type="file" id="animIn" multiple style="display:none"></div>
        </div>
    </div>

    <div id="posControls">
        <span>Смещение анимации:</span>
        <label>X: <input type="number" id="posX" value="0"></label>
        <label>Y: <input type="number" id="posY" value="0"></label>
        <small>(Можно двигать мышкой по картинке)</small>
    </div>

    <div id="workArea">
        <canvas id="bgCanvasPreview"></canvas>
    </div>

    <div id="fileList" class="file-list"></div>

    <div class="controls-grid" style="grid-template-columns: 2fr 1fr;">
        <button class="btn btn-preset" onclick="applySMPreset()">Пресет СМ медали</button>
        <button class="btn" style="background:#dc3545; color:white;" onclick="location.reload()">Очистить всё</button>
    </div>

    <button id="buildBtn" class="btn btn-build" disabled>Собрать готовый APNG</button>
    <div id="status" style="text-align:center; margin-top:10px;"></div>

    <div id="resultContainer" style="display:none; text-align:center; border-top:2px solid #eee; margin-top:20px; padding-top:10px;">
        <div id="finalSize" style="font-weight:bold; margin-bottom:10px;"></div>
        <img id="finalPreview" style="max-width:100%; border:1px solid #ccc;"><br><br>
        <a id="dlBtn" class="download-btn" style="background:#007bff; color:white; padding:10px 20px; text-decoration:none; border-radius:6px; font-weight:bold;">Скачать результат</a>
    </div>
</div>

<script>
    let animationFiles = [];
    let bgImg = null;
    let animPreviewImg = null;
    let offX = 0, offY = 0;
    const canvas = document.getElementById('bgCanvasPreview');
    const ctx = canvas.getContext('2d');

    // Логика загрузки
    setupZone('dzBg', 'bgIn', async f => {
        bgImg = await loadImage(f[0]);
        canvas.width = bgImg.width;
        canvas.height = bgImg.height;
        drawPreview();
    });

    setupZone('dzAnim', 'animIn', async f => {
        const newFiles = Array.from(f);
        animationFiles = animationFiles.concat(newFiles);
        animationFiles.sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric:true}));
        if (animationFiles.length > 0) animPreviewImg = await loadImage(animationFiles[0]);
        renderList();
        drawPreview();
    });

    function setupZone(id, inId, cb) {
        const z = document.getElementById(id), i = document.getElementById(inId);
        z.onclick = () => i.click();
        z.ondragover = e => { e.preventDefault(); z.classList.add('highlight'); };
        z.ondragleave = () => z.classList.remove('highlight');
        z.ondrop = e => { e.preventDefault(); z.classList.remove('highlight'); cb(e.dataTransfer.files); };
        i.onchange = () => cb(i.files);
    }

    // Визуальная отрисовка превью
    function drawPreview() {
        if (!bgImg) return;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(bgImg, 0, 0);
        
        if (animPreviewImg) {
            ctx.globalAlpha = 0.7; // Делаем анимацию чуть прозрачной в превью для удобства позиционирования
            ctx.drawImage(animPreviewImg, offX, offY);
            ctx.globalAlpha = 1.0;
            // Рисуем рамку вокруг перемещаемого объекта
            ctx.strokeStyle = '#007bff';
            ctx.strokeRect(offX, offY, animPreviewImg.width, animPreviewImg.height);
        }
    }

    // Управление мышкой
    let isDragging = false;
    canvas.onmousedown = () => isDragging = true;
    window.onmouseup = () => isDragging = false;
    canvas.onmousemove = (e) => {
        if (isDragging && animPreviewImg) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            offX = Math.round((e.clientX - rect.left) * scaleX - animPreviewImg.width/2);
            offY = Math.round((e.clientY - rect.top) * scaleY - animPreviewImg.height/2);
            document.getElementById('posX').value = offX;
            document.getElementById('posY').value = offY;
            drawPreview();
        }
    };

    document.getElementById('posX').oninput = (e) => { offX = parseInt(e.target.value) || 0; drawPreview(); };
    document.getElementById('posY').oninput = (e) => { offY = parseInt(e.target.value) || 0; drawPreview(); };

    function renderList() {
        const c = document.getElementById('fileList');
        c.innerHTML = animationFiles.map((f, i) => `
            <div class="file-item">
                <b>${i+1}</b> <img src="${URL.createObjectURL(f)}">
                <span style="flex-grow:1">${f.name}</span>
                <input type="number" class="delay-input" value="10"> <small>1/100s</small>
            </div>
        `).join('');
        document.getElementById('buildBtn').disabled = (animationFiles.length === 0 || !bgImg);
    }

    function applySMPreset() {
        const inputs = document.querySelectorAll('.delay-input');
        const count = animationFiles.length;
        if (count !== 19 && count !== 20) return alert("Нужно 19 или 20 кадров!");
        inputs.forEach((input, i) => {
            const n = i + 1; let d = 10;
            if (count === 19) {
                if ([2,9,11,18].includes(n)) d = 8;
                else if ([3,4,5,6,7,8,12,13,14,15,16,17].includes(n)) d = 16;
                else if (n === 1) d = 25; else if (n === 19) d = 66; else if (n === 10) d = 100;
            } else {
                if ([2,6,7,10,12,19].includes(n)) d = 8;
                else if ([3,4,5,8,9,13,14,15,16,17,18].includes(n)) d = 16;
                else if (n === 1) d = 25; else if (n === 20) d = 66; else if (n === 11) d = 100;
            }
            input.value = d;
        });
    }

    document.getElementById('buildBtn').onclick = async () => {
        const st = document.getElementById('status');
        st.innerText = "⏳ Идет сборка...";
        try {
            const delays = Array.from(document.querySelectorAll('.delay-input')).map(i => (parseInt(i.value)||10)*10);
            const frames = [];
            const finalW = canvas.width, finalH = canvas.height;

            for (let f of animationFiles) {
                const img = await loadImage(f);
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = finalW; tempCanvas.height = finalH;
                const tCtx = tempCanvas.getContext('2d');
                tCtx.drawImage(bgImg, 0, 0);
                tCtx.drawImage(img, offX, offY);
                frames.push(tCtx.getImageData(0,0,finalW,finalH).data.buffer);
            }

            const resBuf = UPNG.encode(frames, finalW, finalH, 0, delays);
            const blob = new Blob([resBuf], {type:"image/png"});
            document.getElementById('finalPreview').src = URL.createObjectURL(blob);
            document.getElementById('dlBtn').href = URL.createObjectURL(blob);
            document.getElementById('dlBtn').download = "medal_custom.png";
            document.getElementById('finalSize').innerText = "Вес: " + (blob.size/1024).toFixed(2) + " КБ";
            document.getElementById('resultContainer').style.display = "block";
            st.innerText = "✅ Готово!";
        } catch (e) { st.innerText = "❌ Ошибка: " + e.message; }
    };

    function loadImage(file) {
        return new Promise(res => {
            const img = new Image();
            img.onload = () => res(img);
            img.src = URL.createObjectURL(file);
        });
    }
</script>
</body>
</html>
