<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APNG Builder: CM Medal Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/pako@1.0.11/dist/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/upng-js@2.1.0/UPNG.min.js"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); width: 100%; max-width: 650px; }
        h2 { margin: 0 0 10px 0; color: #1a1a1a; }
        .preset-bar { background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeeba; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #eef0f2; border-radius: 8px; }
        .section-title { font-weight: bold; margin-bottom: 10px; display: block; color: #555; }
        .drop-zone { border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.3s; color: #777; }
        .drop-zone.highlight { border-color: #007bff; background: #e7f3ff; }
        .file-item { display: flex; align-items: center; gap: 10px; background: #fff; padding: 8px; margin-bottom: 5px; border-radius: 6px; border: 1px solid #eee; font-size: 13px; }
        .file-item img { width: 35px; height: 35px; object-fit: contain; background: #eee; }
        .file-item input { width: 55px; padding: 4px; border: 1px solid #ddd; }
        #buildBtn { width: 100%; background: #28a745; color: white; border: none; padding: 15px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        #buildBtn:disabled { background: #ccc; }
        #status { margin-top: 15px; text-align: center; font-weight: bold; }
        #resultContainer { margin-top: 20px; text-align: center; display: none; border-top: 2px solid #eee; padding-top: 20px; }
        #preview { border: 1px solid #ddd; background: #fff; padding: 5px; }
        .btn-preset { background: #ffc107; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .btn-preset:hover { background: #e0a800; }
    </style>
</head>
<body>

<div class="card">
    <h2>–°–±–æ—Ä—â–∏–∫ APNG</h2>

    <div class="preset-bar">
        <span>–ü—Ä–µ—Å–µ—Ç: <strong>–°–ú –º–µ–¥–∞–ª–∏ ($41 \times 70$)</strong></span>
        <button class="btn-preset" onclick="applyMedalPreset()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∏</button>
    </div>
    
    <div class="section">
        <span class="section-title">1. –§–æ–Ω ($41 \times 70$)</span>
        <div id="dropZoneBg" class="drop-zone" style="padding:10px;">
            –ö–ª–∏–∫ –∏–ª–∏ Drop (–§–æ–Ω)
            <input type="file" id="bgInput" accept="image/png, image/jpeg" style="display:none">
        </div>
        <div id="bgPreviewContainer" style="display:none; align-items:center; gap:10px; margin-top:10px;">
            <img id="bgThumb" style="height:30px;">
            <button onclick="clearBg()">‚ùå</button>
        </div>
    </div>

    <div class="section">
        <span class="section-title">2. –ö–∞–¥—Ä—ã (19 –∏–ª–∏ 20 —à—Ç—É–∫)</span>
        <div id="dropZoneAnim" class="drop-zone">
            –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∫–∞–¥—Ä—ã —Å—é–¥–∞
            <input type="file" id="fileInput" multiple accept="image/png" style="display:none">
        </div>
        <div id="fileList" style="margin-top:10px; max-height:200px; overflow-y:auto;"></div>
    </div>

    <button id="buildBtn" disabled>–°–æ–±—Ä–∞—Ç—å APNG</button>
    <div id="status"></div>

    <div id="resultContainer">
        <div style="font-weight:bold; margin-bottom:5px;" id="finalSize"></div>
        <img id="preview"><br><br>
        <a id="downloadLink" style="background:#007bff; color:white; padding:10px 20px; text-decoration:none; border-radius:6px; font-weight:bold;">–°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</a>
    </div>
</div>

<script>
    let animationFiles = [];
    let bgFile = null;
    let useMedalSizes = true; // –î–ª—è –º–µ–¥–∞–ª–µ–π –≤—Å–µ–≥–¥–∞ —Ñ–æ—Ä—Å–∏–º 41x70

    // –°—Ö–µ–º—ã –∑–∞–¥–µ—Ä–∂–µ–∫ (–Ω–æ–º–µ—Ä–∞ –∫–∞–¥—Ä–æ–≤ 1-indexed -> –∑–∞–¥–µ—Ä–∂–∫–∞)
    const preset19 = {
        8: [2, 9, 11, 18],
        16: [3, 4, 5, 6, 7, 8, 12, 13, 14, 15, 16, 17],
        25: [1], 66: [19], 100: [10]
    };
    const preset20 = {
        8: [2, 6, 7, 10, 12, 19],
        16: [3, 4, 5, 8, 9, 13, 14, 15, 16, 17, 18],
        25: [1], 66: [20], 100: [11]
    };

    function applyMedalPreset() {
        const count = animationFiles.length;
        if (count !== 19 && count !== 20) {
            alert(`–î–ª—è –ø—Ä–µ—Å–µ—Ç–∞ –Ω—É–∂–Ω–æ 19 –∏–ª–∏ 20 –∫–∞–¥—Ä–æ–≤. –£ –≤–∞—Å: ${count}`);
            return;
        }

        const scheme = count === 19 ? preset19 : preset20;
        const inputs = document.querySelectorAll('.delay-input');

        inputs.forEach((input, idx) => {
            const frameNum = idx + 1;
            for (let delay in scheme) {
                if (scheme[delay].includes(frameNum)) {
                    input.value = delay;
                }
            }
        });
        alert("–ó–∞–¥–µ—Ä–∂–∫–∏ –ø—Ä–µ—Å–µ—Ç–∞ –°–ú –º–µ–¥–∞–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!");
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ Drop Zones
    function initZone(id, inputId, cb) {
        const z = document.getElementById(id);
        const i = document.getElementById(inputId);
        z.onclick = () => i.click();
        z.ondragover = (e) => { e.preventDefault(); z.classList.add('highlight'); };
        z.ondragleave = () => z.classList.remove('highlight');
        z.ondrop = (e) => { e.preventDefault(); z.classList.remove('highlight'); cb(e.dataTransfer.files); };
        i.onchange = (e) => cb(e.target.files);
    }

    initZone('dropZoneBg', 'bgInput', (fs) => {
        bgFile = fs[0];
        document.getElementById('bgThumb').src = URL.createObjectURL(bgFile);
        document.getElementById('bgPreviewContainer').style.display = 'flex';
    });

    initZone('dropZoneAnim', 'fileInput', (fs) => {
        animationFiles = [...animationFiles, ...Array.from(fs)];
        renderFiles();
    });

    function renderFiles() {
        const list = document.getElementById('fileList');
        list.innerHTML = '';
        animationFiles.forEach((f, i) => {
            const d = document.createElement('div');
            d.className = 'file-item';
            d.innerHTML = `<span>${i+1}</span><img src="${URL.createObjectURL(f)}"><div style="flex-grow:1">${f.name}</div>
            <input type="number" class="delay-input" value="200"> –º—Å
            <button onclick="animationFiles.splice(${i},1);renderFiles()">üóëÔ∏è</button>`;
            list.appendChild(d);
        });
        document.getElementById('buildBtn').disabled = animationFiles.length === 0;
    }

    function clearBg() { bgFile = null; document.getElementById('bgPreviewContainer').style.display = 'none'; }

    // –°–±–æ—Ä–∫–∞
    document.getElementById('buildBtn').onclick = async () => {
        const status = document.getElementById('status');
        status.innerText = "‚è≥ –°–±–æ—Ä–∫–∞ –º–µ–¥–∞–ª–µ–π...";
        try {
            const delays = Array.from(document.querySelectorAll('.delay-input')).map(v => parseInt(v.value) || 100);
            const frames = [];
            const W = 41, H = 70; // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è –º–µ–¥–∞–ª–µ–π

            let bgImg = bgFile ? await loadImage(bgFile) : null;

            for (let file of animationFiles) {
                const img = await loadImage(file);
                const canvas = document.createElement('canvas');
                canvas.width = W; canvas.height = H;
                const ctx = canvas.getContext('2d');

                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ñ–æ–Ω–∞
                if (bgImg) ctx.drawImage(bgImg, 0, 0, W, H);
                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞–¥—Ä–∞
                ctx.drawImage(img, 0, 0, W, H);
                
                frames.push(ctx.getImageData(0, 0, W, H).data.buffer);
            }

            const res = UPNG.encode(frames, W, H, 0, delays);
            const blob = new Blob([res], {type: "image/png"});
            
            document.getElementById('preview').src = URL.createObjectURL(blob);
            document.getElementById('finalSize').innerText = `–†–∞–∑–º–µ—Ä: ${W}x${H} | –í–µ—Å: ${(blob.size/1024).toFixed(1)} KB`;
            document.getElementById('downloadLink').href = URL.createObjectURL(blob);
            document.getElementById('downloadLink').download = "medal_animation.png";
            document.getElementById('resultContainer').style.display = "block";
            status.innerText = "‚úÖ –ì–æ—Ç–æ–≤–æ!";
        } catch (e) {
            status.innerText = "‚ùå –û—à–∏–±–∫–∞: " + e.message;
        }
    };

    function loadImage(file) {
        return new Promise((res, rej) => {
            const img = new Image();
            img.onload = () => res(img);
            img.onerror = rej;
            img.src = URL.createObjectURL(file);
        });
    }
</script>

</body>
</html>
